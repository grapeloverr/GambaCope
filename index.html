<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5x5 Slot Machine with Bonuses</title>
    <style>
        :root {
            --primary-accent: #FFB74D;
            --background-dark: #212121;
            --text-primary: #FFFFFF;
            --success: #81C784;
            --warning: #FFF176;
            --error: #E57373;
        }

        /* Existing styles remain unchanged */
        /* ... (keep previous CSS styles) ... */
    </style>
</head>
<body>
    <div class="container">
        <h1>5x5 Slot Machine Deluxe</h1>
        
        <div class="tokens">
            🪙 <span id="token-count">1000</span> Tokens
            <div id="bonus-display" style="display: none;">
                🎁 <span id="free-spins">0</span> Free Spins (2x Multiplier)
            </div>
        </div>
        
        <div class="slot-machine">
            <div class="reel" id="reel1">?</div>
            <div class="reel" id="reel2">?</div>
            <div class="reel" id="reel3">?</div>
            <div class="reel" id="reel4">?</div>
            <div class="reel" id="reel5">?</div>
        </div>
        
        <button id="spin-btn">SPIN (10 tokens)</button>
        
        <div class="result" id="result-text"></div>
        
        <div class="symbols">
            <p><strong>Winning Combinations:</strong></p>
            <p>🍇 = Wild Card | 3+ 🍇 = Bonus Round!</p>
            <p>3+ 🍒 = 50 tokens | 5 🍒 = 200 tokens</p>
            <p>3+ 🍋 = 100 tokens | 5 🍋 = 400 tokens</p>
            <p>3+ 🔔 = 150 tokens | 5 🔔 = 600 tokens</p>
            <p>3+ 💎 = 300 tokens | 5 💎 = 1200 tokens</p>
            <p>3+ 7️⃣ = 500 tokens | 5 7️⃣ = 2000 tokens</p>
        </div>
    </div>

    <script>
        class AudioManager {
            constructor() {
                this.sounds = {
                    spin: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
                    win: new Audio('https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3'),
                    bonus: new Audio('https://assets.mixkit.co/active_storage/sfx/2574/2574-preview.mp3'),
                    reelStop: new Audio('https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3')
                };
            }

            play(name) {
                const sound = this.sounds[name];
                if (sound) {
                    sound.currentTime = 0;
                    sound.play();
                }
            }
        }

        class SlotMachine {
            constructor() {
                this.audio = new AudioManager();
                this.reels = [...document.querySelectorAll('.reel')];
                this.spinButton = document.getElementById('spin-btn');
                this.tokens = localStorage.getItem('slotTokens') ? parseInt(localStorage.getItem('slotTokens')) : 1000;
                this.freeSpins = parseInt(localStorage.getItem('freeSpins')) || 0;
                this.multiplier = 1;
                this.symbols = this.generateSymbolConfig();
                this.isSpinning = false;
                this.initialize();
                this.updateBonusDisplay();
            }

            generateSymbolConfig() {
                return [
                    { symbol: '🍇', value: 0, probability: 10, isWild: true }, // Wild symbol
                    { symbol: '🍒', value: 50, probability: 25 },
                    { symbol: '🍋', value: 100, probability: 20 },
                    { symbol: '🔔', value: 150, probability: 15 },
                    { symbol: '💎', value: 300, probability: 10 },
                    { symbol: '7️⃣', value: 500, probability: 5 },
                    { symbol: '❓', value: 0, probability: 15 }
                ];
            }

            initialize() {
                this.updateTokenDisplay();
                this.spinButton.addEventListener('click', () => this.handleSpin());
                document.addEventListener('keydown', (e) => {
                    if (['Space', 'Enter'].includes(e.code)) this.handleSpin();
                });
            }

            handleSpin() {
                if (this.isSpinning || (this.tokens < 10 && this.freeSpins === 0)) return;
                
                if (this.freeSpins === 0) {
                    this.tokens -= 10;
                } else {
                    this.freeSpins--;
                    localStorage.setItem('freeSpins', this.freeSpins);
                    this.updateBonusDisplay();
                }
                
                this.updateTokenDisplay();
                this.startSpinning();
            }

            startSpinning() {
                this.audio.play('spin');
                this.isSpinning = true;
                this.spinButton.disabled = true;
                document.getElementById('result-text').textContent = '';
                
                const results = Array.from({ length: 5 }, () => this.getRandomSymbol());
                this.animateReels(results);
            }

            animateReels(results) {
                const startTime = Date.now();
                const spinDuration = 2000;
                const reelElements = this.reels;

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / spinDuration, 1);

                    reelElements.forEach((reel, index) => {
                        if (progress < 0.7 + (index * 0.06)) {
                            reel.textContent = this.symbols[
                                Math.floor(Math.random() * this.symbols.length)
                            ].symbol;
                        } else {
                            reel.textContent = results[index].symbol;
                            if (progress > 0.8 && !this.animationStopped) {
                                this.audio.play('reelStop');
                                this.animationStopped = true;
                            }
                        }
                    });

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        this.handleSpinComplete(results);
                    }
                };

                this.animationStopped = false;
                requestAnimationFrame(animate);
            }

            getRandomSymbol() {
                const totalWeight = this.symbols.reduce((acc, curr) => acc + curr.probability, 0);
                const randomValue = Math.random() * totalWeight;
                let cumulative = 0;

                for (const symbol of this.symbols) {
                    cumulative += symbol.probability;
                    if (randomValue <= cumulative) return symbol;
                }
                return this.symbols[0];
            }

            handleSpinComplete(results) {
                this.isSpinning = false;
                this.spinButton.disabled = false;
                this.calculateWinnings(results);
            }

            calculateWinnings(results) {
                // Check for bonus trigger (3+ grapes)
                const grapeCount = results.filter(s => s.symbol === '🍇').length;
                if (grapeCount >= 3) {
                    this.activateBonus();
                    return;
                }

                // Wild card substitution
                const wildCount = results.filter(s => s.isWild).length;
                const symbolCounts = results
                    .filter(s => !s.isWild)
                    .reduce((acc, { symbol }) => {
                        acc[symbol] = (acc[symbol] || 0) + 1;
                        return acc;
                    }, {});

                // Apply wild cards to best possible combination
                let maxSymbol = null;
                let maxCount = 0;
                Object.entries(symbolCounts).forEach(([symbol, count]) => {
                    const total = count + wildCount;
                    if (total > maxCount || (total === maxCount && 
                        this.symbols.find(s => s.symbol === symbol).value > 
                        this.symbols.find(s => s.symbol === maxSymbol).value)) {
                        maxCount = total;
                        maxSymbol = symbol;
                    }
                });

                if (maxCount >= 3) {
                    const baseValue = this.symbols.find(s => s.symbol === maxSymbol).value;
                    const winnings = baseValue * (maxCount === 5 ? 4 : maxCount === 4 ? 2 : 1) * this.multiplier;
                    this.tokens += winnings;
                    this.showResult(`+${winnings} tokens!`, 'success');
                    this.audio.play('win');
                } else if (maxCount === 2 && wildCount > 0) {
                    this.tokens += 5 * this.multiplier;
                    this.showResult("Wild Pair! +5 tokens", 'info');
                    this.audio.play('win');
                }

                this.updateTokenDisplay();
            }

            activateBonus() {
                this.audio.play('bonus');
                this.freeSpins = 5;
                this.multiplier = 2;
                localStorage.setItem('freeSpins', this.freeSpins);
                this.showResult("BONUS ROUND! 5 Free Spins with 2x Multiplier!", 'success');
                this.updateBonusDisplay();
            }

            updateBonusDisplay() {
                const bonusDisplay = document.getElementById('bonus-display');
                const freeSpinsElement = document.getElementById('free-spins');
                if (this.freeSpins > 0) {
                    bonusDisplay.style.display = 'block';
                    freeSpinsElement.textContent = this.freeSpins;
                } else {
                    bonusDisplay.style.display = 'none';
                    this.multiplier = 1;
                }
            }

            showResult(message, type = 'neutral') {
                const resultElement = document.getElementById('result-text');
                resultElement.textContent = message;
                resultElement.style.color = {
                    success: '#81C784',
                    info: '#64B5F6',
                    neutral: '#FFB74D'
                }[type];
            }

            updateTokenDisplay() {
                document.getElementById('token-count').textContent = this.tokens;
                localStorage.setItem('slotTokens', this.tokens);
            }
        }

        // Initialize game
        new SlotMachine();
    </script>
</body>
</html>
